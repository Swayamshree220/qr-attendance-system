{% extends "base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">ðŸ“‹ Your Class Sessions</h2>
    
    {% if sessions %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for session in sessions %}
        <div class="col" id="session-card-{{ session.id }}">
            <!-- Card for each session -->
            <div class="card h-100 shadow-sm session-card">
                <div class="card-body">
                    <h5 class="card-title text-primary">{{ session.class_name }}</h5>
                    <p class="card-text text-muted">Session ID: {{ session.id[:8] }}...</p>
                    
                    <ul class="list-group list-group-flush mt-3">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <i class="fas fa-clock text-info"></i> Start Time
                            <span class="badge bg-info text-dark">{{ session.start_time }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <i class="fas fa-user-check text-success"></i> Attendees
                            <span class="badge bg-success attendance-count">{{ session.attendee_count }}</span>
                        </li>
                    </ul>
                </div>
                <!-- Card Footer with View Report and Delete Icon -->
                <div class="card-footer d-flex justify-content-between align-items-center bg-light">
                    <!-- Link to report (main action) -->
                    <a href="{{ url_for('routes.view_reports', session_id=session.id) }}" class="btn btn-sm btn-outline-primary flex-grow-1 me-2">View Report</a>
                    
                    <!-- Delete Button with Icon -->
                    <button class="btn btn-sm btn-outline-danger delete-session-btn" data-id="{{ session.id }}">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        You have not created any attendance sessions yet. Go to Generate QR to start.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
.session-card {
    transition: transform 0.2s ease-in-out;
    cursor: pointer;
    border: 1px solid #ddd;
}
.session-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 15px rgba(52, 152, 219, 0.2);
    border-color: #3498db;
}
/* Ensure the card body is the clickable area for navigation */
.session-card .card-body {
    cursor: pointer;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Event delegation for deleting a session card
    document.querySelectorAll('.delete-session-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation(); // Prevent card click event from firing
            const sessionId = this.getAttribute('data-id');
            const cardElement = document.getElementById(`session-card-${sessionId}`);

            if (!confirm(`WARNING: This will permanently delete the session (${sessionId.substring(0, 8)}...) and ALL associated attendance records. Are you sure?`)) {
                return;
            }

            // Call the backend API to delete the session
            fetch(`/delete-session/${sessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the card from the UI
                    if (cardElement) {
                        cardElement.remove();
                    }
                    alert(data.message);
                } else {
                    alert('Deletion Failed: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error during session deletion.');
                console.error('Delete error:', error);
            });
        });
    });
    
    // Add click handler to view report when clicking the card body (excluding buttons)
    document.querySelectorAll('.session-card').forEach(card => {
        card.addEventListener('click', function(event) {
            // Check if the click target or its parent is the delete button
            if (event.target.closest('.delete-session-btn') || event.target.closest('a')) {
                return; 
            }
            // Navigate if the click wasn't on an interactive element
            const reportLink = this.querySelector('a.btn-outline-primary');
            if (reportLink) {
                window.location.href = reportLink.href;
            }
        });
    });

});
</script>
{% endblock %}
