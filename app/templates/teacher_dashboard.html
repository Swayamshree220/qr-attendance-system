{% extends "base.html" %}

{% block title %}Teacher Dashboard{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">ðŸ“‹ Your Class Sessions</h2>
    
    {% if sessions %}
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
        {% for session in sessions %}
        <div class="col" id="session-card-{{ session.id }}">
            <div class="card h-100 shadow-sm session-card">
                <div class="card-body">
                    <!-- ... (content omitted) ... -->
                </div>
                <!-- Card Footer with View Report and Delete Icon -->
                <div class="card-footer d-flex justify-content-between align-items-center bg-light">
                    <!-- FIX: Ensure the route name and session_id variable are correct -->
                    <a href="{{ url_for('routes.view_reports', session_id=session.id) }}" 
                       class="btn btn-sm btn-outline-primary flex-grow-1 me-2">
                       View Report
                    </a>
                    
                    <!-- Delete Button -->
                    <button class="btn btn-sm btn-outline-danger delete-session-btn" data-id="{{ session.id }}">
                        <i class="fas fa-trash-alt"></i> Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        You have not created any attendance sessions yet. Go to Generate QR to start.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<style>
/* ... (CSS styles and JS omitted for brevity) ... */
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Event listener for deleting a session card
    document.querySelectorAll('.delete-session-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.stopPropagation(); 
            event.preventDefault(); 
            
            const sessionId = this.getAttribute('data-id');
            const cardElement = document.getElementById(`session-card-${sessionId}`);

            if (!confirm(`WARNING: This will permanently delete the session (${sessionId.substring(0, 8)}...) and ALL associated attendance records. Are you sure?`)) {
                return;
            }

            // Call the backend API to delete the session
            fetch(`/delete-session/${sessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (cardElement) {
                        cardElement.remove();
                    }
                    alert(data.message);
                } else {
                    alert('Deletion Failed: ' + data.message);
                }
            })
            .catch(error => {
                alert('Network error during session deletion. Please check server logs.');
                console.error('Delete error:', error);
            });
        });
    });
    
    // Add click handler to view report when clicking the card body (excluding buttons)
    document.querySelectorAll('.session-card').forEach(card => {
        card.addEventListener('click', function(event) {
            if (event.target.closest('button') || event.target.closest('a')) {
                return; 
            }
            // Navigate if the click wasn't on an interactive element
            const reportLink = this.querySelector('a.btn-outline-primary');
            if (reportLink) {
                window.location.href = reportLink.href;
            }
        });
    });

});
</script>
{% endblock %}
