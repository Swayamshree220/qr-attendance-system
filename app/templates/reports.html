{% extends "base.html" %}

{% block title %}Attendance Report{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="mb-4">Attendance Report for Session: {{ session_id }}</h2>
    
    {% if records %}
    
    <!-- GeoFence Map Section (Requires the first record's data to initialize) -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">üìç Geofence Visualization (Expected Location)</h5>
        </div>
        <div class="card-body">
            <!-- Map Container -->
            <div id="geofence-map" style="height: 300px; border-radius: 5px; border: 1px solid #ddd;"></div>
            <small class="text-muted mt-2 d-block">The blue circle shows the 50-meter valid scanning zone for this session.</small>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <p class="mb-0">Found {{ records|length }} attendance records.</p>
        <a href="{{ url_for('routes.export_report', session_id=session_id) }}" class="btn btn-success">Download Report (CSV)</a>
    </div>

    <table class="table table-bordered table-striped">
        <thead class="table-dark">
            <tr>
                <th>Student ID</th>
                <th>Name</th>
                <th>Timestamp (IST)</th>
                <th>Proxy Status</th>
            </tr>
        </thead>
        <tbody>
            <!-- FIX APPLIED: Unpack four variables (record, user, session, ist_time) -->
            {% for record, user, session, ist_time in records %} 
            <tr>
                <td>{{ user.id }}</td>
                <td>{{ user.name }}</td>
                <td>{{ ist_time.strftime('%Y-%m-%d %I:%M %p IST') }}</td>
                <td>
                    {% if record.proxy_detected == 'Suspicious' %}
                    <span class="badge bg-warning text-dark">Suspicious</span>
                    {% else %}
                    <span class="badge bg-success">Legit</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="alert alert-info" role="alert">
        No attendance records found for this session.
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<!-- Leaflet CSS and JS for mapping -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
    // This script runs only if records exist.
    {% if records %}
        // Access ClassSession (index [2]) to get qr_data
        const qrDataString = "{{ records[0][2].qr_data }}"; 
        
        // Use regular expression to safely extract LAT and LON values
        const latMatch = qrDataString.match(/LAT:(-?\d+\.?\d*)/);
        const lonMatch = qrDataString.match(/LON:(-?\d+\.?\d*)/);

        if (latMatch && lonMatch) {
            const sessionLat = parseFloat(latMatch[1]);
            const sessionLon = parseFloat(lonMatch[1]);

            // Leaflet Map Initialization
            const map = L.map('geofence-map').setView([sessionLat, sessionLon], 16); 

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add a marker for the exact expected location
            L.marker([sessionLat, sessionLon]).addTo(map)
                .bindPopup('Class Location')
                .openPopup();

            // Add the Geofence Circle (50-meter radius)
            L.circle([sessionLat, sessionLon], {
                color: 'blue',
                fillColor: '#007bff',
                fillOpacity: 0.2,
                radius: 50 
            }).addTo(map).bindPopup('Allowed Geofence (50 meters)');
        }

    {% endif %}
</script>
{% endblock %}
